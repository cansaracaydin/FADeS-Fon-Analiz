
==================================================
DOSYA ADI: .\app.py
==================================================

import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import plotly.express as px
import plotly.graph_objects as go
import time
from core.tefas_fetcher import TefasFetcher
from core.processor import DataProcessor
from core.market_fetcher import MarketFetcher
from core.inflation_fetcher import InflationFetcher

# --- SAYFA AYARLARI ---
st.set_page_config(page_title="FADeS - Fon Analiz Paneli", layout="wide", page_icon="ğŸ“ˆ")

# CSS: GÃ¶rsel Ä°yileÅŸtirmeler
st.markdown("""
    <style>
    /* BaÅŸlÄ±k rengini zorla BEYAZ yap (Koyu modda gÃ¶rÃ¼nmesi iÃ§in) */
    h1 { color: white !important; }
    
    /* Metrik deÄŸerlerini (RakamlarÄ±) mavi yap */
    div[data-testid="stMetricValue"] { font-size: 24px; color: #007bff; }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ“Š GeliÅŸmiÅŸ Fon Analiz ve SimÃ¼lasyon Paneli")

# --- YAN MENÃœ ---
st.sidebar.header("âš™ï¸ Analiz AyarlarÄ±")

# 1. MOD SEÃ‡Ä°MÄ°
st.sidebar.markdown("---")
calisma_modu = st.sidebar.radio(
    "Ne Yapmak Ä°stersiniz?",
    ["ğŸ“ˆ DetaylÄ± Analiz", "ğŸ†š TEFAS KarÅŸÄ±laÅŸtÄ±rma", "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu"]
)

# 2. TARÄ°H SEÃ‡Ä°MÄ° (ENFLASYON Ä°Ã‡Ä°N YUKARI TAÅINDI)
st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“… Tarih AralÄ±ÄŸÄ±")
col_t1, col_t2 = st.sidebar.columns(2)
baslangic_tarihi = col_t1.date_input("BaÅŸlangÄ±Ã§", datetime.now() - timedelta(days=365))
bitis_tarihi = col_t2.date_input("BitiÅŸ", datetime.now())

# 3. BENCHMARK SEÃ‡Ä°MÄ°
benchmark_secimi = st.sidebar.selectbox(
    "KarÅŸÄ±laÅŸtÄ±rma Ã–lÃ§Ã¼tÃ¼ (Benchmark):",
    ["Yok", "Dolar (USD/TRY)", "AltÄ±n (Ons/USD)"]
)

# --- DÄ°NAMÄ°K ENFLASYON YÃ–NETÄ°MÄ° (TAM KARNE MODU) ---
st.sidebar.markdown("---")
with st.sidebar.expander("ğŸ’¸ Enflasyon Verileri (TCMB/TÃœÄ°K Karnesi)", expanded=False):
    st.caption(f"TCMB formatÄ±nda tÃ¼m gÃ¶stergeler ({baslangic_tarihi} - {bitis_tarihi})")
    
    evds_api_key = st.text_input("TCMB API AnahtarÄ± (Opsiyonel)", type="password")
    
    col_api, col_manual = st.columns(2)
    
    # 1. API Ä°LE Ã‡EK
    if evds_api_key:
        if col_api.button("ğŸ”„ TCMB'den Ã‡ek", key="btn_tcmb_cek"):
            with st.spinner("TCMB'den detaylÄ± veriler alÄ±nÄ±yor..."):
                inf_fetcher = InflationFetcher(evds_api_key)
                
                # Fetcher artÄ±k 4 farklÄ± hesaplama yapÄ±yor ve NaN temizliyor
                api_data = inf_fetcher.fetch_inflation_data(
                    start_date_obj=baslangic_tarihi,
                    end_date_obj=bitis_tarihi
                )
                
                if not api_data.empty:
                    st.success("Veriler AlÄ±ndÄ±!")
                    st.session_state['enflasyon_verisi'] = api_data
                else:
                    st.error("Veri alÄ±namadÄ±!")

    # 2. MANUEL ÅABLON OLUÅTURMA
    if col_manual.button("ğŸ“… Åablon OluÅŸtur", key="btn_sablon_olustur"):
        dates = pd.date_range(start=baslangic_tarihi, end=bitis_tarihi, freq='MS') 
        template_data = {
            "Tarih": dates, 
            "AylÄ±k Enflasyon": [3.0] * len(dates),
            "YÄ±llÄ±k Enflasyon": [45.0] * len(dates),
            "YÄ±lbaÅŸÄ±na GÃ¶re": [25.0] * len(dates),
            "12 AylÄ±k Ort. DeÄŸ.": [50.0] * len(dates),
            "Oran": [3.0] * len(dates) # Hesaplama iÃ§in aylÄ±k kullanÄ±lÄ±r
        }
        st.session_state['enflasyon_verisi'] = pd.DataFrame(template_data)
        st.toast("Åablon oluÅŸturuldu.")

    # 3. TABLO GÃ–STERÄ°MÄ°
    if 'enflasyon_verisi' not in st.session_state or st.session_state['enflasyon_verisi'] is None:
        st.session_state['enflasyon_verisi'] = pd.DataFrame(columns=["Tarih", "Oran"])

    inf_df = st.session_state['enflasyon_verisi'].copy()
    
    if not inf_df.empty:
        # Tarih formatÄ± dÃ¼zenlemesi (GÃ¶rsel tablo iÃ§in sadece Tarih)
        if "Tarih" in inf_df.columns:
             inf_df["Tarih"] = pd.to_datetime(inf_df["Tarih"])

        st.write("ğŸ“Š **Enflasyon GÃ¶stergeleri (%)**")
        
        # FormatlÄ± Tablo GÃ¶sterimi
        st.dataframe(
            inf_df, 
            hide_index=True,
            column_config={
                "Tarih": st.column_config.DateColumn("DÃ¶nem", format="YYYY-MM-DD"),
                "AylÄ±k Enflasyon": st.column_config.NumberColumn("AylÄ±k (MoM)", format="%.2f%%"),
                "YÄ±llÄ±k Enflasyon": st.column_config.NumberColumn("YÄ±llÄ±k (YoY)", format="%.2f%%"),
                "YÄ±lbaÅŸÄ±na GÃ¶re": st.column_config.NumberColumn("YÄ±lbaÅŸÄ±na GÃ¶re (YTD)", format="%.2f%%"),
                "12 AylÄ±k Ort. DeÄŸ.": st.column_config.NumberColumn("12 Ay Ort.", format="%.2f%%"),
                "Oran": None # Bunu gizle (Hesaplama sÃ¼tunu)
            }
        )
        
        # Grafik SeÃ§eneÄŸi
        gosterim_tipi = st.selectbox(
            "Grafikte GÃ¶ster:", 
            ["AylÄ±k Enflasyon", "YÄ±llÄ±k Enflasyon", "12 AylÄ±k Ort. DeÄŸ."], 
            index=1 # VarsayÄ±lan YÄ±llÄ±k
        )
        
        if gosterim_tipi in inf_df.columns:
            st.line_chart(inf_df, x="Tarih", y=gosterim_tipi, color="#FF4B4B")
            
        st.info("â„¹ï¸ Not: PortfÃ¶y simÃ¼lasyonunda 'Reel Getiri' hesaplanÄ±rken **AylÄ±k Enflasyon** verisi kullanÄ±lÄ±r.")

# 4. FON LÄ°STESÄ°
st.sidebar.markdown("---")
kuveyt_turk_fonlari = [
    "KZL", "KZU", "KUT", "KGM", "KSV", "KLU", "KTV", "KTN", "KTR", 
    "KDL", "KTT", "KPD", "KAV", "KCV", "KTM", "KME", "KDE", "KUD", 
    "KUA", "KPC", "KPU", "KPA", "KTS", "KTJ", "KNJ", "KSR", "KIK"
]

secilen_fonlar = st.sidebar.multiselect(
    "FonlarÄ± SeÃ§in:",
    options=kuveyt_turk_fonlari, 
    default=["KUT", "KPC", "KCV", "KNJ", "KTJ", "KGM"] 
)

# --- SÄ°MÃœLASYON AYARLARI ---
portfoy_agirliklari = {}
baslangic_sermayesi = 100000
simulasyon_sayisi = 100

if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
    st.sidebar.markdown("---")
    st.sidebar.subheader("ğŸ’° PortfÃ¶y YapÄ±landÄ±rma")
    
    # 1. SERMAYE GÄ°RÄ°ÅÄ°
    baslangic_sermayesi = st.sidebar.number_input(
        "YatÄ±rÄ±m Sermayesi (TL)", 
        min_value=1000, 
        max_value=100000000, 
        value=100000, 
        step=1000,
        format="%d", 
        help="BaÅŸlangÄ±Ã§ bakiyenizi buraya yazabilirsiniz."
    )
    
    # 2. SÄ°MÃœLASYON SAYISI
    simulasyon_sayisi = st.sidebar.number_input(
        "Monte Carlo Senaryo SayÄ±sÄ±", 
        min_value=10, max_value=5000, value=50, step=10,
        help="Daha yÃ¼ksek sayÄ± = Daha hassas tahmin."
    )
    
    st.sidebar.write("### âš–ï¸ Fon AÄŸÄ±rlÄ±klarÄ± (%)")
    
    # 3. AÄIRLIKLAR
    toplam_agirlik = 0
    if secilen_fonlar:
        varsayilan = int(100 / len(secilen_fonlar))
        
        for fon in secilen_fonlar:
            c1, c2 = st.sidebar.columns([3, 1])
            with c1:
                slider_val = st.slider(f"{fon}", 0, 100, varsayilan, key=f"slide_{fon}", label_visibility="collapsed")
            with c2:
                input_val = st.number_input(f"val_{fon}", 0.0, 100.0, float(slider_val), step=0.5, key=f"num_{fon}", label_visibility="collapsed")
            
            st.sidebar.caption(f"**{fon}:** %{input_val}")
            portfoy_agirliklari[fon] = input_val / 100.0
            toplam_agirlik += input_val
        
        if abs(toplam_agirlik - 100) > 0.1:
            st.sidebar.error(f"âš ï¸ Toplam: %{toplam_agirlik:.1f} (100 olmalÄ±!)")
        else:
            st.sidebar.success("âœ… DaÄŸÄ±lÄ±m Dengeli (%100)")
    else:
        st.sidebar.info("Fon seÃ§iniz.")

# Buton Metni AyarÄ±
if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
    buton_metni = "ğŸ° SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r"
else:
    buton_metni = "ğŸš€ Analizi BaÅŸlat"

# --- SESSION STATE KONTROLÃœ ---
if 'analiz_verileri' not in st.session_state:
    st.session_state['analiz_verileri'] = None
if 'varlik_dagilimi' not in st.session_state:
    st.session_state['varlik_dagilimi'] = {} 

# --- VERÄ° Ã‡EKME Ä°ÅLEMÄ° ---
if st.sidebar.button(buton_metni, type="primary"):
    
    if not secilen_fonlar:
        st.warning("LÃ¼tfen listeden en az bir fon seÃ§iniz.")
    else:
        st.info(f"Mod: {calisma_modu} | Veriler iÅŸleniyor... (LÃ¼tfen bekleyiniz)")
        durum = st.empty()
        bar = st.progress(0)
        
        fetcher = TefasFetcher()
        processor = DataProcessor()
        market_fetcher = MarketFetcher()
        
        tum_veriler = []
        varlik_dagilimlari = {}

        try:
            # 1. FON VERÄ°LERÄ°NÄ° Ã‡EK
            for i, fon in enumerate(secilen_fonlar):
                durum.text(f"â³ Ã‡ekiliyor: {fon} ({i+1}/{len(secilen_fonlar)})...")
                try:
                    # Tarihsel Fiyat Ã‡ek
                    raw_df = fetcher.fetch_data(fon, str(baslangic_tarihi), str(bitis_tarihi))
                    if not raw_df.empty:
                        clean_df = processor.clean_data(raw_df)
                        final_df = processor.add_financial_metrics(clean_df)
                        if not final_df.empty:
                            final_df["FundCode"] = fon 
                            final_df["Date"] = pd.to_datetime(final_df["Date"])
                            tum_veriler.append(final_df)
                    
                    # VarlÄ±k DaÄŸÄ±lÄ±mÄ±nÄ± Ã‡ek
                    asset_df = fetcher.fetch_asset_allocation(fon, str(bitis_tarihi))
                    if not asset_df.empty:
                        varlik_dagilimlari[fon] = asset_df

                    time.sleep(0.5) 
                except Exception as e:
                    st.error(f"âš ï¸ {fon} hatasÄ±: {e}")
                bar.progress((i + 1) / len(secilen_fonlar))

            # 2. BENCHMARK EKLE
            if benchmark_secimi != "Yok":
                durum.text(f"ğŸŒ Benchmark ekleniyor: {benchmark_secimi}...")
                sembol = "USDTRY=X" if "Dolar" in benchmark_secimi else "GC=F"
                isim_kisa = "USD/TRY" if "Dolar" in benchmark_secimi else "ALTIN"
                
                bench_df = market_fetcher.fetch_benchmark(sembol, str(baslangic_tarihi), str(bitis_tarihi))
                if not bench_df.empty:
                    bench_df = processor.add_financial_metrics(bench_df)
                    bench_df["FundCode"] = isim_kisa
                    bench_df["FundName"] = f"Piyasa: {benchmark_secimi}"
                    tum_veriler.append(bench_df)

            # --- VERÄ°YÄ° HAFIZAYA KAYDET ---
            if tum_veriler:
                st.session_state['analiz_verileri'] = tum_veriler
                st.session_state['varlik_dagilimi'] = varlik_dagilimlari 
                st.success("Veriler baÅŸarÄ±yla alÄ±ndÄ±!")
            else:
                st.error("HiÃ§bir veri alÄ±namadÄ±.")

        except Exception as e:
            st.error(f"Beklenmedik bir hata: {e}")
        finally:
            durum.empty()
            bar.empty()
            fetcher.close()

# --- EKRANA BASMA (HafÄ±zadan Okur) ---
if st.session_state['analiz_verileri']:
    
    ham_veriler = st.session_state['analiz_verileri']
    varlik_dagilimi = st.session_state.get('varlik_dagilimi', {})
    processor = DataProcessor()
    
    ozet_rapor = []
    
    for df in ham_veriler:
        metrics = processor.calculate_risk_metrics(df)
        if metrics:
            metrics["Fon Kodu"] = df.iloc[0]["FundCode"]
            metrics["Fon AdÄ±"] = df.iloc[0]["FundName"]
            ozet_rapor.append(metrics)

    # SimÃ¼lasyon HesabÄ±
    tum_veriler_gosterim = ham_veriler.copy()
    
    if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
        temp_full_df = pd.concat(ham_veriler, ignore_index=True)
        sim_df = processor.calculate_portfolio_simulation(temp_full_df, portfoy_agirliklari, baslangic_sermayesi)
        
        if not sim_df.empty:
            tum_veriler_gosterim.append(sim_df)
            p_metrics = processor.calculate_risk_metrics(sim_df)
            if p_metrics:
                p_metrics["Fon Kodu"] = "PORTFOY"
                p_metrics["Fon AdÄ±"] = "ğŸ”´ BENÄ°M PORTFÃ–YÃœM"
                ozet_rapor.append(p_metrics)

    full_df = pd.concat(tum_veriler_gosterim, ignore_index=True)
    ozet_df = pd.DataFrame(ozet_rapor)

    # --- SÄ°MÃœLASYON MODU GÃ–RÃœNÃœMÃœ ---
    if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
        st.success("âœ… SimÃ¼lasyon Aktif")
        
        portfoy_data = full_df[full_df["FundCode"] == "PORTFOY"]
        if not portfoy_data.empty:
            son_bakiye = portfoy_data.iloc[-1]["Price"]
            kar_zarar = son_bakiye - baslangic_sermayesi
            kar_orani = (kar_zarar / baslangic_sermayesi) * 100
            
            # 1. SKOR KARTLARI (inf KontrolÃ¼ Ekli)
            col1, col2, col3 = st.columns(3)
            col1.metric("BaÅŸlangÄ±Ã§ Sermayesi", f"{baslangic_sermayesi:,.0f} TL")
            
            if np.isinf(son_bakiye) or np.isnan(son_bakiye):
                st.error("âš ï¸ Veri HatasÄ±: Bakiye hesaplanamadÄ± (Sonsuz veya TanÄ±msÄ±z).")
            else:
                col2.metric("GÃ¼ncel Bakiye (Son)", f"{son_bakiye:,.0f} TL", f"{kar_orani:.2f}%")
                col3.metric("Net Kar/Zarar", f"{kar_zarar:,.0f} TL")
            
            # --- VaR (RÄ°SK ANALÄ°ZÄ°) ---
            st.markdown("---")
            st.subheader("ğŸ›¡ï¸ Risk Analizi: Value at Risk (VaR)")
            
            guven_araligi = st.radio("GÃ¼ven AralÄ±ÄŸÄ± SeÃ§iniz:", ["%95 (Standart)", "%99 (Kriz Senaryosu)"], horizontal=True)
            conf_level = 0.99 if "99" in guven_araligi else 0.95
            
            var_sonuc = processor.calculate_value_at_risk(temp_full_df, portfoy_agirliklari, baslangic_sermayesi, conf_level)
            
            if var_sonuc:
                c1, c2 = st.columns([1, 2])
                with c1:
                    st.error(f"âš ï¸ Maksimum GÃ¼nlÃ¼k KayÄ±p Riski")
                    st.metric(label="VaR TutarÄ± (Riskteki Para)", value=f"-{var_sonuc['VaR_Amount']:,.2f} TL")
                with c2:
                    st.info(f"â„¹ï¸ **Ne Anlama Geliyor?**\n\nÄ°statistiksel olarak **{guven_araligi}** ihtimalle, portfÃ¶yÃ¼nÃ¼zÃ¼n **yarÄ±nki** kaybÄ± bu tutarÄ± geÃ§meyecektir.")
            
            st.markdown("---")
            
            # 2. GRAFÄ°K (MEVCUT DURUM + REEL GETÄ°RÄ°)
            st.markdown("### ğŸ“ˆ PortfÃ¶y BÃ¼yÃ¼me ve Reel Getiri Analizi")
            
            # Reel Getiri HesabÄ± (AylÄ±k Enflasyona GÃ¶re)
            # Burada 'enflasyon_verisi' iÃ§indeki 'Oran' (AylÄ±k Enflasyon) sÃ¼tunu kullanÄ±lÄ±r.
            edited_inf_df = st.session_state.get('enflasyon_verisi', pd.DataFrame())
            if not edited_inf_df.empty and 'Oran' in edited_inf_df.columns:
                try:
                    # Enflasyon NaN ise 0 kabul et, yoksa hata veriyor
                    edited_inf_df["Oran"] = edited_inf_df["Oran"].fillna(0)
                    portfoy_data = processor.calculate_real_returns(portfoy_data, edited_inf_df)
                except Exception as e:
                    st.warning(f"Reel getiri hesaplanÄ±rken hata oluÅŸtu: {e}")
            
            fig_sim = go.Figure()
            
            # Nominal Ã‡izgi
            fig_sim.add_trace(go.Scatter(
                x=portfoy_data["Date"], y=portfoy_data["Cumulative_Return"], 
                name="Nominal Getiri (GÃ¶rÃ¼nen)", 
                line=dict(color='red', width=3)
            ))
            
            # Reel Ã‡izgi (Enflasyonun Ã¼stÃ¼nde misin?)
            if 'Real_Return' in portfoy_data.columns:
                fig_sim.add_trace(go.Scatter(
                    x=portfoy_data["Date"], y=portfoy_data["Real_Return"], 
                    name="Reel Getiri (Enflasyon ArÄ±ndÄ±rÄ±lmÄ±ÅŸ)", 
                    line=dict(color='blue', width=2, dash='dash'),
                    fill='tonexty' 
                ))
            
            fig_sim.update_layout(title="Nominal vs Reel Getiri (AlÄ±m GÃ¼cÃ¼)", yaxis_tickformat='.1%')
            st.plotly_chart(fig_sim, use_container_width=True)
            
            # --- 3. MARKOWITZ OPTÄ°MÄ°ZASYONU ---
            st.markdown("---")
            st.subheader("ğŸ§  Yapay Zeka Optimizasyonu (Markowitz)")
            
            col_opt1, col_opt2 = st.columns([1, 2])
            with col_opt1:
                st.info("2.000 farklÄ± senaryo deneniyor...")
                if st.button("âš¡ En Ä°yi PortfÃ¶yÃ¼ Bul", type="secondary"):
                    with st.spinner("HesaplanÄ±yor..."):
                        saf_fonlar = [f for f in secilen_fonlar if f in full_df['FundCode'].unique()]
                        ef_df, best_stats = processor.calculate_efficient_frontier(full_df, saf_fonlar)
                        
                        if not ef_df.empty:
                            st.success("âœ… Optimum DaÄŸÄ±lÄ±m Bulundu!")
                            st.write("### ğŸ† Ã–nerilen DaÄŸÄ±lÄ±m")
                            for fon_kodu, agirlik in best_stats['Weights'].items():
                                st.progress(agirlik)
                                st.write(f"**{fon_kodu}:** %{agirlik*100:.0f}")
                            
                            with col_opt2:
                                fig_ef = px.scatter(
                                    ef_df, x="Volatility", y="Return", color="Sharpe",
                                    title="Etkin SÄ±nÄ±r (Efficient Frontier)",
                                    color_continuous_scale="Viridis"
                                )
                                fig_ef.add_scatter(x=[best_stats['Volatility']], y=[best_stats['Return']], mode='markers', marker=dict(color='red', size=20, symbol='star'), name='En Ä°yi PortfÃ¶y')
                                st.plotly_chart(fig_ef, use_container_width=True)
                        else:
                            st.warning("Yeterli veri yok.")

            # --- 4. MONTE CARLO SÄ°MÃœLASYONU ---
            st.markdown("---")
            st.subheader("ğŸ² Gelecek Tahmini: Monte Carlo SimÃ¼lasyonu")
            
            mc_col1, mc_col2 = st.columns([1, 3])
            
            with mc_col1:
                st.write(f"GeleceÄŸe yÃ¶nelik **{simulasyon_sayisi}** farklÄ± senaryo Ã¼retilir.")
                gun_sayisi = st.slider("KaÃ§ GÃ¼n Ä°leriye Gitmek Ä°stersiniz?", 30, 365, 180)
                
                if st.button("ğŸ”® GeleceÄŸi SimÃ¼le Et", type="primary"):
                    with st.spinner("OlasÄ±lÄ±klar hesaplanÄ±yor..."):
                        mc_df = processor.run_monte_carlo_simulation(
                            temp_full_df, 
                            portfoy_agirliklari, 
                            son_bakiye, 
                            days_forward=gun_sayisi, 
                            num_simulations=simulasyon_sayisi
                        )
                        
                        if not mc_df.empty:
                            with mc_col2:
                                fig_mc = px.line(mc_df, x='Date', y=mc_df.columns[1:], 
                                                 title=f"Gelecek {gun_sayisi} GÃ¼n Ä°Ã§in OlasÄ± Senaryolar",
                                                 labels={"value": "PortfÃ¶y DeÄŸeri (TL)", "Date": "Tarih"})
                                fig_mc.update_traces(line=dict(width=1), opacity=0.3)
                                fig_mc.update_layout(showlegend=False) 
                                st.plotly_chart(fig_mc, use_container_width=True)
                                
                                # Ä°statistikler
                                son_gun_degerleri = mc_df.iloc[-1, 1:]
                                ortalama_senaryo = son_gun_degerleri.mean()
                                kotu_senaryo = son_gun_degerleri.quantile(0.10) 
                                iyi_senaryo = son_gun_degerleri.quantile(0.90) 
                                
                                c1, c2, c3 = st.columns(3)
                                c1.metric("KÃ¶tÃ¼ Senaryo (Taban)", f"{kotu_senaryo:,.0f} TL")
                                c2.metric("Beklenen Senaryo (Ort)", f"{ortalama_senaryo:,.0f} TL")
                                c3.metric("Ä°yi Senaryo (Tavan)", f"{iyi_senaryo:,.0f} TL")

    # --- DÄ°ÄER MODLAR ---
    else:
        st.subheader("ğŸ“ˆ Analiz SonuÃ§larÄ±")
        tab1, tab2, tab3 = st.tabs(["Grafik", "Ã–zet Tablo", "ğŸ¥§ VarlÄ±k DaÄŸÄ±lÄ±mÄ±"]) 
        
        with tab1:
            fig = px.line(full_df, x="Date", y="Cumulative_Return", color="FundCode")
            fig.layout.yaxis.tickformat = ',.0%'
            st.plotly_chart(fig, use_container_width=True)
        with tab2:
            if not ozet_df.empty: st.dataframe(ozet_df)
        
        with tab3:
            if varlik_dagilimi:
                st.info("Bu grafikler fonlarÄ±n en son aÃ§Ä±klanan portfÃ¶y daÄŸÄ±lÄ±mÄ±nÄ± gÃ¶sterir.")
                cols = st.columns(2) 
                
                for i, (fon_kodu, df_asset) in enumerate(varlik_dagilimi.items()):
                    if not df_asset.empty:
                        with cols[i % 2]: 
                            fig_pie = px.pie(
                                df_asset, 
                                values='Oran', 
                                names='VarlÄ±k TÃ¼rÃ¼', 
                                title=f"{fon_kodu} - VarlÄ±k DaÄŸÄ±lÄ±mÄ±"
                            )
                            fig_pie.update_traces(textposition='inside', textinfo='percent+label')
                            st.plotly_chart(fig_pie, use_container_width=True)
            else:
                st.warning("VarlÄ±k daÄŸÄ±lÄ±m verisi Ã§ekilemedi veya fon seÃ§ilmedi.")

    # Excel Ä°ndir
    import io
    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
        full_df.to_excel(writer, index=False, sheet_name='Veriler')
        if not ozet_df.empty: ozet_df.to_excel(writer, index=False, sheet_name='Ozet')
    st.download_button("ğŸ“¥ Excel Raporunu Ä°ndir", data=buffer.getvalue(), file_name="Analiz.xlsx")

==================================================
DOSYA ADI: .\main.py
==================================================

from core.tefas_fetcher import TefasFetcher
from core.processor import DataProcessor
from core.visualizer import Visualizer
from core.market_fetcher import MarketFetcher # <-- YENÄ°: Dolar iÃ§in eklendi
from datetime import datetime, timedelta
import pandas as pd
import os

def main():
    # --- AYARLAR ---
    fon_kodlari = ["TCD", "MAC", "TI3", "IPJ"] 
    benchmark_sembol = "USDTRY=X" # Dolar: USDTRY=X, AltÄ±n: GC=F
    gun_sayisi = 90
    
    bugun = datetime.now()
    baslangic = bugun - timedelta(days=gun_sayisi)
    
    str_bugun = bugun.strftime("%Y-%m-%d")
    str_baslangic = baslangic.strftime("%Y-%m-%d")

    print(f"--- FADeS Analiz Sistemi ({str_baslangic} - {str_bugun}) ---")

    # MotorlarÄ± BaÅŸlat
    fetcher = TefasFetcher()      # Fon verisi iÃ§in (Chrome)
    market_fetcher = MarketFetcher() # Piyasa verisi iÃ§in (Yahoo) <-- YENÄ°
    processor = DataProcessor()   # Hesaplamalar
    visualizer = Visualizer()     # Grafik
    
    tum_fonlar = []

    try:
        # 1. FONLARI Ã‡EK
        # -------------------------------------------------
        print(f"\nğŸ“Š FONLAR Ä°ÅLENÄ°YOR...")
        for kod in fon_kodlari:
            print(f"> {kod} verisi alÄ±nÄ±yor...")
            
            # Browser Ã¼zerinden Ã§ek
            raw_df = fetcher.fetch_data(kod, str_baslangic, str_bugun)
            
            if raw_df.empty: continue

            # Temizle ve Hesapla
            clean_df = processor.clean_data(raw_df)
            final_df = processor.add_financial_metrics(clean_df)
            
            if final_df.empty:
                print(f"  âš ï¸ {kod} verisi iÅŸlenemedi.")
                continue
            
            tum_fonlar.append(final_df)
            
            son_getiri = final_df['Cumulative_Return'].iloc[-1] * 100
            print(f"  + {kod} Getiri: %{son_getiri:.2f}")

        # 2. BENCHMARK (DOLAR) VERÄ°SÄ°NÄ° Ã‡EK VE EKLE
        # -------------------------------------------------
        print(f"\nğŸŒ PÄ°YASA VERÄ°SÄ° (BENCHMARK) EKLENÄ°YOR...")
        bench_df = market_fetcher.fetch_benchmark(benchmark_sembol, str_baslangic, str_bugun)

        if not bench_df.empty:
            # DolarÄ± da fon formatÄ±na sokuyoruz (Getiri hesabÄ± iÃ§in)
            bench_df = processor.add_financial_metrics(bench_df)
            
            # Sisteme tanÄ±talÄ±m
            bench_df["FundCode"] = "USD/TRY"
            bench_df["FundName"] = "Dolar Kuru"
            
            tum_fonlar.append(bench_df) # <-- Listeye ekledik!
            
            dolar_getiri = bench_df['Cumulative_Return'].iloc[-1] * 100
            print(f"  + USD/TRY Getiri: %{dolar_getiri:.2f}")
        else:
            print("  âš ï¸ Piyasa verisi Ã§ekilemedi.")

    finally:
        print("\nğŸ›‘ TarayÄ±cÄ± kapatÄ±lÄ±yor...")
        fetcher.close()

    # --- RAPORLAMA ---
    if tum_fonlar:
        full_report = pd.concat(tum_fonlar, ignore_index=True)
        
        # KlasÃ¶r kontrolÃ¼
        if not os.path.exists('reports'): os.makedirs('reports')
        
        # Excel Kaydet
        excel_path = f"reports/Analiz_Raporu_{bugun.strftime('%Y%m%d')}.xlsx"
        full_report.to_excel(excel_path, index=False)
        print(f"\nâœ… EXCEL HAZIR: {excel_path}")

        # Grafik Ã‡iz (ArtÄ±k iÃ§inde Dolar da var)
        visualizer.create_performance_chart(full_report)
    else:
        print("\nâŒ HiÃ§bir veri elde edilemedi.")

if __name__ == "__main__":
    main()

==================================================
DOSYA ADI: .\test_api.py
==================================================

from core.inflation_fetcher import InflationFetcher

# SÄ±nÄ±fÄ± Ã§aÄŸÄ±r (Anahtar zaten dosyanÄ±n iÃ§inde gÃ¶mÃ¼lÃ¼)
fetcher = InflationFetcher() 

print("--- TEST BAÅLIYOR ---")
veri = fetcher.fetch_inflation_data()

if not veri.empty:
    print("\nğŸ‰ SONUÃ‡ BAÅARILI! Ä°ÅŸte ilk 5 satÄ±r:")
    print(veri.head())
else:
    print("\nğŸ’€ TEST BAÅARISIZ OLDU.")

==================================================
DOSYA ADI: .\TUM_PROJE_KODLARI.txt
==================================================


==================================================
DOSYA ADI: .\app.py
==================================================

import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import plotly.express as px
import plotly.graph_objects as go
import time
from core.tefas_fetcher import TefasFetcher
from core.processor import DataProcessor
from core.market_fetcher import MarketFetcher
from core.inflation_fetcher import InflationFetcher

# --- SAYFA AYARLARI ---
st.set_page_config(page_title="FADeS - Fon Analiz Paneli", layout="wide", page_icon="ğŸ“ˆ")

# CSS: GÃ¶rsel Ä°yileÅŸtirmeler
st.markdown("""
    <style>
    /* BaÅŸlÄ±k rengini zorla BEYAZ yap (Koyu modda gÃ¶rÃ¼nmesi iÃ§in) */
    h1 { color: white !important; }
    
    /* Metrik deÄŸerlerini (RakamlarÄ±) mavi yap */
    div[data-testid="stMetricValue"] { font-size: 24px; color: #007bff; }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ“Š GeliÅŸmiÅŸ Fon Analiz ve SimÃ¼lasyon Paneli")

# --- YAN MENÃœ ---
st.sidebar.header("âš™ï¸ Analiz AyarlarÄ±")

# 1. MOD SEÃ‡Ä°MÄ°
st.sidebar.markdown("---")
calisma_modu = st.sidebar.radio(
    "Ne Yapmak Ä°stersiniz?",
    ["ğŸ“ˆ DetaylÄ± Analiz", "ğŸ†š TEFAS KarÅŸÄ±laÅŸtÄ±rma", "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu"]
)

# 2. TARÄ°H SEÃ‡Ä°MÄ° (ENFLASYON Ä°Ã‡Ä°N YUKARI TAÅINDI)
st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“… Tarih AralÄ±ÄŸÄ±")
col_t1, col_t2 = st.sidebar.columns(2)
baslangic_tarihi = col_t1.date_input("BaÅŸlangÄ±Ã§", datetime.now() - timedelta(days=365))
bitis_tarihi = col_t2.date_input("BitiÅŸ", datetime.now())

# 3. BENCHMARK SEÃ‡Ä°MÄ°
benchmark_secimi = st.sidebar.selectbox(
    "KarÅŸÄ±laÅŸtÄ±rma Ã–lÃ§Ã¼tÃ¼ (Benchmark):",
    ["Yok", "Dolar (USD/TRY)", "AltÄ±n (Ons/USD)"]
)

# --- DÄ°NAMÄ°K ENFLASYON YÃ–NETÄ°MÄ° (TAM KARNE MODU) ---
st.sidebar.markdown("---")
with st.sidebar.expander("ğŸ’¸ Enflasyon Verileri (TCMB/TÃœÄ°K Karnesi)", expanded=False):
    st.caption(f"TCMB formatÄ±nda tÃ¼m gÃ¶stergeler ({baslangic_tarihi} - {bitis_tarihi})")
    
    evds_api_key = st.text_input("TCMB API AnahtarÄ± (Opsiyonel)", type="password")
    
    col_api, col_manual = st.columns(2)
    
    # 1. API Ä°LE Ã‡EK
    if evds_api_key:
        if col_api.button("ğŸ”„ TCMB'den Ã‡ek", key="btn_tcmb_cek"):
            with st.spinner("TCMB'den detaylÄ± veriler alÄ±nÄ±yor..."):
                inf_fetcher = InflationFetcher(evds_api_key)
                
                # Fetcher artÄ±k 4 farklÄ± hesaplama yapÄ±yor ve NaN temizliyor
                api_data = inf_fetcher.fetch_inflation_data(
                    start_date_obj=baslangic_tarihi,
                    end_date_obj=bitis_tarihi
                )
                
                if not api_data.empty:
                    st.success("Veriler AlÄ±ndÄ±!")
                    st.session_state['enflasyon_verisi'] = api_data
                else:
                    st.error("Veri alÄ±namadÄ±!")

    # 2. MANUEL ÅABLON OLUÅTURMA
    if col_manual.button("ğŸ“… Åablon OluÅŸtur", key="btn_sablon_olustur"):
        dates = pd.date_range(start=baslangic_tarihi, end=bitis_tarihi, freq='MS') 
        template_data = {
            "Tarih": dates, 
            "AylÄ±k Enflasyon": [3.0] * len(dates),
            "YÄ±llÄ±k Enflasyon": [45.0] * len(dates),
            "YÄ±lbaÅŸÄ±na GÃ¶re": [25.0] * len(dates),
            "12 AylÄ±k Ort. DeÄŸ.": [50.0] * len(dates),
            "Oran": [3.0] * len(dates) # Hesaplama iÃ§in aylÄ±k kullanÄ±lÄ±r
        }
        st.session_state['enflasyon_verisi'] = pd.DataFrame(template_data)
        st.toast("Åablon oluÅŸturuldu.")

    # 3. TABLO GÃ–STERÄ°MÄ°
    if 'enflasyon_verisi' not in st.session_state or st.session_state['enflasyon_verisi'] is None:
        st.session_state['enflasyon_verisi'] = pd.DataFrame(columns=["Tarih", "Oran"])

    inf_df = st.session_state['enflasyon_verisi'].copy()
    
    if not inf_df.empty:
        # Tarih formatÄ± dÃ¼zenlemesi (GÃ¶rsel tablo iÃ§in sadece Tarih)
        if "Tarih" in inf_df.columns:
             inf_df["Tarih"] = pd.to_datetime(inf_df["Tarih"])

        st.write("ğŸ“Š **Enflasyon GÃ¶stergeleri (%)**")
        
        # FormatlÄ± Tablo GÃ¶sterimi
        st.dataframe(
            inf_df, 
            hide_index=True,
            column_config={
                "Tarih": st.column_config.DateColumn("DÃ¶nem", format="YYYY-MM-DD"),
                "AylÄ±k Enflasyon": st.column_config.NumberColumn("AylÄ±k (MoM)", format="%.2f%%"),
                "YÄ±llÄ±k Enflasyon": st.column_config.NumberColumn("YÄ±llÄ±k (YoY)", format="%.2f%%"),
                "YÄ±lbaÅŸÄ±na GÃ¶re": st.column_config.NumberColumn("YÄ±lbaÅŸÄ±na GÃ¶re (YTD)", format="%.2f%%"),
                "12 AylÄ±k Ort. DeÄŸ.": st.column_config.NumberColumn("12 Ay Ort.", format="%.2f%%"),
                "Oran": None # Bunu gizle (Hesaplama sÃ¼tunu)
            }
        )
        
        # Grafik SeÃ§eneÄŸi
        gosterim_tipi = st.selectbox(
            "Grafikte GÃ¶ster:", 
            ["AylÄ±k Enflasyon", "YÄ±llÄ±k Enflasyon", "12 AylÄ±k Ort. DeÄŸ."], 
            index=1 # VarsayÄ±lan YÄ±llÄ±k
        )
        
        if gosterim_tipi in inf_df.columns:
            st.line_chart(inf_df, x="Tarih", y=gosterim_tipi, color="#FF4B4B")
            
        st.info("â„¹ï¸ Not: PortfÃ¶y simÃ¼lasyonunda 'Reel Getiri' hesaplanÄ±rken **AylÄ±k Enflasyon** verisi kullanÄ±lÄ±r.")

# 4. FON LÄ°STESÄ°
st.sidebar.markdown("---")
kuveyt_turk_fonlari = [
    "KZL", "KZU", "KUT", "KGM", "KSV", "KLU", "KTV", "KTN", "KTR", 
    "KDL", "KTT", "KPD", "KAV", "KCV", "KTM", "KME", "KDE", "KUD", 
    "KUA", "KPC", "KPU", "KPA", "KTS", "KTJ", "KNJ", "KSR", "KIK"
]

secilen_fonlar = st.sidebar.multiselect(
    "FonlarÄ± SeÃ§in:",
    options=kuveyt_turk_fonlari, 
    default=["KUT", "KPC", "KCV", "KNJ", "KTJ", "KGM"] 
)

# --- SÄ°MÃœLASYON AYARLARI ---
portfoy_agirliklari = {}
baslangic_sermayesi = 100000
simulasyon_sayisi = 100

if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
    st.sidebar.markdown("---")
    st.sidebar.subheader("ğŸ’° PortfÃ¶y YapÄ±landÄ±rma")
    
    # 1. SERMAYE GÄ°RÄ°ÅÄ°
    baslangic_sermayesi = st.sidebar.number_input(
        "YatÄ±rÄ±m Sermayesi (TL)", 
        min_value=1000, 
        max_value=100000000, 
        value=100000, 
        step=1000,
        format="%d", 
        help="BaÅŸlangÄ±Ã§ bakiyenizi buraya yazabilirsiniz."
    )
    
    # 2. SÄ°MÃœLASYON SAYISI
    simulasyon_sayisi = st.sidebar.number_input(
        "Monte Carlo Senaryo SayÄ±sÄ±", 
        min_value=10, max_value=5000, value=50, step=10,
        help="Daha yÃ¼ksek sayÄ± = Daha hassas tahmin."
    )
    
    st.sidebar.write("### âš–ï¸ Fon AÄŸÄ±rlÄ±klarÄ± (%)")
    
    # 3. AÄIRLIKLAR
    toplam_agirlik = 0
    if secilen_fonlar:
        varsayilan = int(100 / len(secilen_fonlar))
        
        for fon in secilen_fonlar:
            c1, c2 = st.sidebar.columns([3, 1])
            with c1:
                slider_val = st.slider(f"{fon}", 0, 100, varsayilan, key=f"slide_{fon}", label_visibility="collapsed")
            with c2:
                input_val = st.number_input(f"val_{fon}", 0.0, 100.0, float(slider_val), step=0.5, key=f"num_{fon}", label_visibility="collapsed")
            
            st.sidebar.caption(f"**{fon}:** %{input_val}")
            portfoy_agirliklari[fon] = input_val / 100.0
            toplam_agirlik += input_val
        
        if abs(toplam_agirlik - 100) > 0.1:
            st.sidebar.error(f"âš ï¸ Toplam: %{toplam_agirlik:.1f} (100 olmalÄ±!)")
        else:
            st.sidebar.success("âœ… DaÄŸÄ±lÄ±m Dengeli (%100)")
    else:
        st.sidebar.info("Fon seÃ§iniz.")

# Buton Metni AyarÄ±
if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
    buton_metni = "ğŸ° SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r"
else:
    buton_metni = "ğŸš€ Analizi BaÅŸlat"

# --- SESSION STATE KONTROLÃœ ---
if 'analiz_verileri' not in st.session_state:
    st.session_state['analiz_verileri'] = None
if 'varlik_dagilimi' not in st.session_state:
    st.session_state['varlik_dagilimi'] = {} 

# --- VERÄ° Ã‡EKME Ä°ÅLEMÄ° ---
if st.sidebar.button(buton_metni, type="primary"):
    
    if not secilen_fonlar:
        st.warning("LÃ¼tfen listeden en az bir fon seÃ§iniz.")
    else:
        st.info(f"Mod: {calisma_modu} | Veriler iÅŸleniyor... (LÃ¼tfen bekleyiniz)")
        durum = st.empty()
        bar = st.progress(0)
        
        fetcher = TefasFetcher()
        processor = DataProcessor()
        market_fetcher = MarketFetcher()
        
        tum_veriler = []
        varlik_dagilimlari = {}

        try:
            # 1. FON VERÄ°LERÄ°NÄ° Ã‡EK
            for i, fon in enumerate(secilen_fonlar):
                durum.text(f"â³ Ã‡ekiliyor: {fon} ({i+1}/{len(secilen_fonlar)})...")
                try:
                    # Tarihsel Fiyat Ã‡ek
                    raw_df = fetcher.fetch_data(fon, str(baslangic_tarihi), str(bitis_tarihi))
                    if not raw_df.empty:
                        clean_df = processor.clean_data(raw_df)
                        final_df = processor.add_financial_metrics(clean_df)
                        if not final_df.empty:
                            final_df["FundCode"] = fon 
                            final_df["Date"] = pd.to_datetime(final_df["Date"])
                            tum_veriler.append(final_df)
                    
                    # VarlÄ±k DaÄŸÄ±lÄ±mÄ±nÄ± Ã‡ek
                    asset_df = fetcher.fetch_asset_allocation(fon, str(bitis_tarihi))
                    if not asset_df.empty:
                        varlik_dagilimlari[fon] = asset_df

                    time.sleep(0.5) 
                except Exception as e:
                    st.error(f"âš ï¸ {fon} hatasÄ±: {e}")
                bar.progress((i + 1) / len(secilen_fonlar))

            # 2. BENCHMARK EKLE
            if benchmark_secimi != "Yok":
                durum.text(f"ğŸŒ Benchmark ekleniyor: {benchmark_secimi}...")
                sembol = "USDTRY=X" if "Dolar" in benchmark_secimi else "GC=F"
                isim_kisa = "USD/TRY" if "Dolar" in benchmark_secimi else "ALTIN"
                
                bench_df = market_fetcher.fetch_benchmark(sembol, str(baslangic_tarihi), str(bitis_tarihi))
                if not bench_df.empty:
                    bench_df = processor.add_financial_metrics(bench_df)
                    bench_df["FundCode"] = isim_kisa
                    bench_df["FundName"] = f"Piyasa: {benchmark_secimi}"
                    tum_veriler.append(bench_df)

            # --- VERÄ°YÄ° HAFIZAYA KAYDET ---
            if tum_veriler:
                st.session_state['analiz_verileri'] = tum_veriler
                st.session_state['varlik_dagilimi'] = varlik_dagilimlari 
                st.success("Veriler baÅŸarÄ±yla alÄ±ndÄ±!")
            else:
                st.error("HiÃ§bir veri alÄ±namadÄ±.")

        except Exception as e:
            st.error(f"Beklenmedik bir hata: {e}")
        finally:
            durum.empty()
            bar.empty()
            fetcher.close()

# --- EKRANA BASMA (HafÄ±zadan Okur) ---
if st.session_state['analiz_verileri']:
    
    ham_veriler = st.session_state['analiz_verileri']
    varlik_dagilimi = st.session_state.get('varlik_dagilimi', {})
    processor = DataProcessor()
    
    ozet_rapor = []
    
    for df in ham_veriler:
        metrics = processor.calculate_risk_metrics(df)
        if metrics:
            metrics["Fon Kodu"] = df.iloc[0]["FundCode"]
            metrics["Fon AdÄ±"] = df.iloc[0]["FundName"]
            ozet_rapor.append(metrics)

    # SimÃ¼lasyon HesabÄ±
    tum_veriler_gosterim = ham_veriler.copy()
    
    if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
        temp_full_df = pd.concat(ham_veriler, ignore_index=True)
        sim_df = processor.calculate_portfolio_simulation(temp_full_df, portfoy_agirliklari, baslangic_sermayesi)
        
        if not sim_df.empty:
            tum_veriler_gosterim.append(sim_df)
            p_metrics = processor.calculate_risk_metrics(sim_df)
            if p_metrics:
                p_metrics["Fon Kodu"] = "PORTFOY"
                p_metrics["Fon AdÄ±"] = "ğŸ”´ BENÄ°M PORTFÃ–YÃœM"
                ozet_rapor.append(p_metrics)

    full_df = pd.concat(tum_veriler_gosterim, ignore_index=True)
    ozet_df = pd.DataFrame(ozet_rapor)

    # --- SÄ°MÃœLASYON MODU GÃ–RÃœNÃœMÃœ ---
    if calisma_modu == "ğŸ’¼ PortfÃ¶y SimÃ¼lasyonu":
        st.success("âœ… SimÃ¼lasyon Aktif")
        
        portfoy_data = full_df[full_df["FundCode"] == "PORTFOY"]
        if not portfoy_data.empty:
            son_bakiye = portfoy_data.iloc[-1]["Price"]
            kar_zarar = son_bakiye - baslangic_sermayesi
            kar_orani = (kar_zarar / baslangic_sermayesi) * 100
            
            # 1. SKOR KARTLARI (inf KontrolÃ¼ Ekli)
            col1, col2, col3 = st.columns(3)
            col1.metric("BaÅŸlangÄ±Ã§ Sermayesi", f"{baslangic_sermayesi:,.0f} TL")
            
            if np.isinf(son_bakiye) or np.isnan(son_bakiye):
                st.error("âš ï¸ Veri HatasÄ±: Bakiye hesaplanamadÄ± (Sonsuz veya TanÄ±msÄ±z).")
            else:
                col2.metric("GÃ¼ncel Bakiye (Son)", f"{son_bakiye:,.0f} TL", f"{kar_orani:.2f}%")
                col3.metric("Net Kar/Zarar", f"{kar_zarar:,.0f} TL")
            
            # --- VaR (RÄ°SK ANALÄ°ZÄ°) ---
            st.markdown("---")
            st.subheader("ğŸ›¡ï¸ Risk Analizi: Value at Risk (VaR)")
            
            guven_araligi = st.radio("GÃ¼ven AralÄ±ÄŸÄ± SeÃ§iniz:", ["%95 (Standart)", "%99 (Kriz Senaryosu)"], horizontal=True)
            conf_level = 0.99 if "99" in guven_araligi else 0.95
            
            var_sonuc = processor.calculate_value_at_risk(temp_full_df, portfoy_agirliklari, baslangic_sermayesi, conf_level)
            
            if var_sonuc:
                c1, c2 = st.columns([1, 2])
                with c1:
                    st.error(f"âš ï¸ Maksimum GÃ¼nlÃ¼k KayÄ±p Riski")
                    st.metric(label="VaR TutarÄ± (Riskteki Para)", value=f"-{var_sonuc['VaR_Amount']:,.2f} TL")
                with c2:
                    st.info(f"â„¹ï¸ **Ne Anlama Geliyor?**\n\nÄ°statistiksel olarak **{guven_araligi}** ihtimalle, portfÃ¶yÃ¼nÃ¼zÃ¼n **yarÄ±nki** kaybÄ± bu tutarÄ± geÃ§meyecektir.")
            
            st.markdown("---")
            
            # 2. GRAFÄ°K (MEVCUT DURUM + REEL GETÄ°RÄ°)
            st.markdown("### ğŸ“ˆ PortfÃ¶y BÃ¼yÃ¼me ve Reel Getiri Analizi")
            
            # Reel Getiri HesabÄ± (AylÄ±k Enflasyona GÃ¶re)
            # Burada 'enflasyon_verisi' iÃ§indeki 'Oran' (AylÄ±k Enflasyon) sÃ¼tunu kullanÄ±lÄ±r.
            edited_inf_df = st.session_state.get('enflasyon_verisi', pd.DataFrame())
            if not edited_inf_df.empty and 'Oran' in edited_inf_df.columns:
                try:
                    # Enflasyon NaN ise 0 kabul et, yoksa hata veriyor
                    edited_inf_df["Oran"] = edited_inf_df["Oran"].fillna(0)
                    portfoy_data = processor.calculate_real_returns(portfoy_data, edited_inf_df)
                except Exception as e:
                    st.warning(f"Reel getiri hesaplanÄ±rken hata oluÅŸtu: {e}")
            
            fig_sim = go.Figure()
            
            # Nominal Ã‡izgi
            fig_sim.add_trace(go.Scatter(
                x=portfoy_data["Date"], y=portfoy_data["Cumulative_Return"], 
                name="Nominal Getiri (GÃ¶rÃ¼nen)", 
                line=dict(color='red', width=3)
            ))
            
            # Reel Ã‡izgi (Enflasyonun Ã¼stÃ¼nde misin?)
            if 'Real_Return' in portfoy_data.columns:
                fig_sim.add_trace(go.Scatter(
                    x=portfoy_data["Date"], y=portfoy_data["Real_Return"], 
                    name="Reel Getiri (Enflasyon ArÄ±ndÄ±rÄ±lmÄ±ÅŸ)", 
                    line=dict(color='blue', width=2, dash='dash'),
                    fill='tonexty' 
                ))
            
            fig_sim.update_layout(title="Nominal vs Reel Getiri (AlÄ±m GÃ¼cÃ¼)", yaxis_tickformat='.1%')
            st.plotly_chart(fig_sim, use_container_width=True)
            
            # --- 3. MARKOWITZ OPTÄ°MÄ°ZASYONU ---
            st.markdown("---")
            st.subheader("ğŸ§  Yapay Zeka Optimizasyonu (Markowitz)")
            
            col_opt1, col_opt2 = st.columns([1, 2])
            with col_opt1:
                st.info("2.000 farklÄ± senaryo deneniyor...")
                if st.button("âš¡ En Ä°yi PortfÃ¶yÃ¼ Bul", type="secondary"):
                    with st.spinner("HesaplanÄ±yor..."):
                        saf_fonlar = [f for f in secilen_fonlar if f in full_df['FundCode'].unique()]
                        ef_df, best_stats = processor.calculate_efficient_frontier(full_df, saf_fonlar)
                        
                        if not ef_df.empty:
                            st.success("âœ… Optimum DaÄŸÄ±lÄ±m Bulundu!")
                            st.write("### ğŸ† Ã–nerilen DaÄŸÄ±lÄ±m")
                            for fon_kodu, agirlik in best_stats['Weights'].items():
                                st.progress(agirlik)
                                st.write(f"**{fon_kodu}:** %{agirlik*100:.0f}")
                            
                            with col_opt2:
                                fig_ef = px.scatter(
                                    ef_df, x="Volatility", y="Return", color="Sharpe",
                                    title="Etkin SÄ±nÄ±r (Efficient Frontier)",
                                    color_continuous_scale="Viridis"
                                )
                                fig_ef.add_scatter(x=[best_stats['Volatility']], y=[best_stats['Return']], mode='markers', marker=dict(color='red', size=20, symbol='star'), name='En Ä°yi PortfÃ¶y')
                                st.plotly_chart(fig_ef, use_container_width=True)
                        else:
                            st.warning("Yeterli veri yok.")

            # --- 4. MONTE CARLO SÄ°MÃœLASYONU ---
            st.markdown("---")
            st.subheader("ğŸ² Gelecek Tahmini: Monte Carlo SimÃ¼lasyonu")
            
            mc_col1, mc_col2 = st.columns([1, 3])
            
            with mc_col1:
                st.write(f"GeleceÄŸe yÃ¶nelik **{simulasyon_sayisi}** farklÄ± senaryo Ã¼retilir.")
                gun_sayisi = st.slider("KaÃ§ GÃ¼n Ä°leriye Gitmek Ä°stersiniz?", 30, 365, 180)
                
                if st.button("ğŸ”® GeleceÄŸi SimÃ¼le Et", type="primary"):
                    with st.spinner("OlasÄ±lÄ±klar hesaplanÄ±yor..."):
                        mc_df = processor.run_monte_carlo_simulation(
                            temp_full_df, 
                            portfoy_agirliklari, 
                            son_bakiye, 
                            days_forward=gun_sayisi, 
                            num_simulations=simulasyon_sayisi
                        )
                        
                        if not mc_df.empty:
                            with mc_col2:
                                fig_mc = px.line(mc_df, x='Date', y=mc_df.columns[1:], 
                                                 title=f"Gelecek {gun_sayisi} GÃ¼n Ä°Ã§in OlasÄ± Senaryolar",
                                                 labels={"value": "PortfÃ¶y DeÄŸeri (TL)", "Date": "Tarih"})
                                fig_mc.update_traces(line=dict(width=1), opacity=0.3)
                                fig_mc.update_layout(showlegend=False) 
                                st.plotly_chart(fig_mc, use_container_width=True)
                                
                                # Ä°statistikler
                                son_gun_degerleri = mc_df.iloc[-1, 1:]
                                ortalama_senaryo = son_gun_degerleri.mean()
                                kotu_senaryo = son_gun_degerleri.quantile(0.10) 
                                iyi_senaryo = son_gun_degerleri.quantile(0.90) 
                                
                                c1, c2, c3 = st.columns(3)
                                c1.metric("KÃ¶tÃ¼ Senaryo (Taban)", f"{kotu_senaryo:,.0f} TL")
                                c2.metric("Beklenen Senaryo (Ort)", f"{ortalama_senaryo:,.0f} TL")
                                c3.metric("Ä°yi Senaryo (Tavan)", f"{iyi_senaryo:,.0f} TL")

    # --- DÄ°ÄER MODLAR ---
    else:
        st.subheader("ğŸ“ˆ Analiz SonuÃ§larÄ±")
        tab1, tab2, tab3 = st.tabs(["Grafik", "Ã–zet Tablo", "ğŸ¥§ VarlÄ±k DaÄŸÄ±lÄ±mÄ±"]) 
        
        with tab1:
            fig = px.line(full_df, x="Date", y="Cumulative_Return", color="FundCode")
            fig.layout.yaxis.tickformat = ',.0%'
            st.plotly_chart(fig, use_container_width=True)
        with tab2:
            if not ozet_df.empty: st.dataframe(ozet_df)
        
        with tab3:
            if varlik_dagilimi:
                st.info("Bu grafikler fonlarÄ±n en son aÃ§Ä±klanan portfÃ¶y daÄŸÄ±lÄ±mÄ±nÄ± gÃ¶sterir.")
                cols = st.columns(2) 
                
                for i, (fon_kodu, df_asset) in enumerate(varlik_dagilimi.items()):
                    if not df_asset.empty:
                        with cols[i % 2]: 
                            fig_pie = px.pie(
                                df_asset, 
                                values='Oran', 
                                names='VarlÄ±k TÃ¼rÃ¼', 
                                title=f"{fon_kodu} - VarlÄ±k DaÄŸÄ±lÄ±mÄ±"
                            )
                            fig_pie.update_traces(textposition='inside', textinfo='percent+label')
                            st.plotly_chart(fig_pie, use_container_width=True)
            else:
                st.warning("VarlÄ±k daÄŸÄ±lÄ±m verisi Ã§ekilemedi veya fon seÃ§ilmedi.")

    # Excel Ä°ndir
    import io
    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
        full_df.to_excel(writer, index=False, sheet_name='Veriler')
        if not ozet_df.empty: ozet_df.to_excel(writer, index=False, sheet_name='Ozet')
    st.download_button("ğŸ“¥ Excel Raporunu Ä°ndir", data=buffer.getvalue(), file_name="Analiz.xlsx")

==================================================
DOSYA ADI: .\core\inflation_fetcher.py
==================================================

import pandas as pd
import requests
import urllib3
from datetime import datetime, timedelta

# Senin AnahtarÄ±n
SABIT_API_KEY = "5bWXZH7oXM"

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class InflationFetcher:
    def __init__(self, api_key=None):
        if api_key and len(api_key) > 5:
            self.api_key = api_key
        else:
            self.api_key = SABIT_API_KEY

    def fetch_inflation_data(self, start_date_obj=None, end_date_obj=None):
        """
        TAM KARNE MODU (FIXED):
        NaN (BoÅŸ) verileri temizler ve tarih formatÄ±nÄ± bozulmaz hale getirir.
        """
        
        if not end_date_obj:
            end_date_obj = datetime.now()
        if not start_date_obj:
            start_date_obj = end_date_obj - timedelta(days=365)

        # GeÃ§miÅŸ veri ihtiyacÄ± (Hesaplamalar iÃ§in 2 yÄ±l geriye git)
        api_start_date = start_date_obj - pd.DateOffset(years=2)
        
        str_api_start = api_start_date.strftime("%d-%m-%Y")
        str_api_end = end_date_obj.strftime("%d-%m-%Y")

        url = (
            f"https://evds2.tcmb.gov.tr/service/evds/"
            f"series=TP.FG.J0"
            f"&startDate={str_api_start}"
            f"&endDate={str_api_end}"
            f"&type=json"
            f"&aggregationTypes=avg"
            f"&formulas=0"
            f"&frequency=1"
        )

        headers = {
            "key": self.api_key,
            "User-Agent": "Mozilla/5.0"
        }

        try:
            response = requests.get(url, headers=headers, verify=False, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                items = data.get("items", [])
                
                if not items:
                    print("âŒ HATA: Liste boÅŸ.")
                    return pd.DataFrame()

                df = pd.DataFrame(items)
                df = df.iloc[:, 0:2]
                df.columns = ["Date", "Index_Value"]

                # 1. TEMÄ°ZLÄ°K
                def clean_number(x):
                    x = str(x)
                    if ',' in x:
                        return x.replace('.', '').replace(',', '.')
                    return x

                df["Index_Value"] = df["Index_Value"].apply(clean_number)
                df["Index_Value"] = pd.to_numeric(df["Index_Value"], errors='coerce')
                df["Date"] = pd.to_datetime(df["Date"], errors='coerce')
                
                df = df.dropna().sort_values("Date")
                
                # 2. HESAPLAMALAR
                # AylÄ±k (MoM)
                df["AylÄ±k Enflasyon"] = df["Index_Value"].pct_change() * 100
                
                # YÄ±llÄ±k (YoY)
                df["YÄ±llÄ±k Enflasyon"] = df["Index_Value"].pct_change(periods=12) * 100
                
                # 12 AylÄ±k Ortalamalar
                df["Rolling_Mean_12"] = df["Index_Value"].rolling(window=12).mean()
                df["12 AylÄ±k Ort. DeÄŸ."] = df["Rolling_Mean_12"].pct_change(periods=12) * 100
                
                # YTD (YÄ±lbaÅŸÄ±na GÃ¶re)
                df["YÄ±l"] = df["Date"].dt.year
                aralik_degerleri = df[df["Date"].dt.month == 12].set_index("YÄ±l")["Index_Value"]
                df["Onceki_Yil"] = df["YÄ±l"] - 1
                df["Ref_Aralik"] = df["Onceki_Yil"].map(aralik_degerleri)
                df["YÄ±lbaÅŸÄ±na GÃ¶re"] = (df["Index_Value"] / df["Ref_Aralik"] - 1) * 100

                # 3. FÄ°LTRELEME (KullanÄ±cÄ±nÄ±n Tarihine DÃ¶n)
                target_start = pd.to_datetime(start_date_obj)
                df = df[df["Date"] >= target_start]
                
                # --- KRÄ°TÄ°K FIX: NaN TEMÄ°ZLÄ°ÄÄ° ---
                # pct_change ilk satÄ±rÄ± NaN yapar, bu da grafikleri bozar.
                # dropna() ile temizliyoruz.
                df = df.dropna(subset=["AylÄ±k Enflasyon"]) 
                
                final_df = df[[
                    "Date", 
                    "AylÄ±k Enflasyon", 
                    "YÄ±lbaÅŸÄ±na GÃ¶re", 
                    "YÄ±llÄ±k Enflasyon", 
                    "12 AylÄ±k Ort. DeÄŸ."
                ]].copy()
                
                # SimÃ¼lasyon iÃ§in "Oran" sÃ¼tunu (AylÄ±k Enflasyon baz alÄ±nÄ±r)
                final_df["Oran"] = final_df["AylÄ±k Enflasyon"]
                
                # Tarih sÃ¼tunu string deÄŸil, datetime kalsÄ±n (App.py'da sorun yaÅŸamamak iÃ§in)
                final_df["Tarih"] = final_df["Date"] 
                
                # Yuvarlama
                cols = ["AylÄ±k Enflasyon", "YÄ±lbaÅŸÄ±na GÃ¶re", "YÄ±llÄ±k Enflasyon", "12 AylÄ±k Ort. DeÄŸ.", "Oran"]
                final_df[cols] = final_df[cols].round(2)
                
                print(f"âœ… BAÅARILI: {len(final_df)} aylÄ±k veri hazÄ±r (NaN temizlendi).")
                return final_df
            
            else:
                print(f"âš ï¸ Hata Kodu: {response.status_code}")
                return pd.DataFrame()

        except Exception as e:
            print(f"â˜ ï¸ HATA: {e}")
            return pd.DataFrame()

==================================================
DOSYA ADI: .\core\market_fetcher.py
==================================================

import yfinance as yf
import pandas as pd

class MarketFetcher:
    def __init__(self):
        pass

    def fetch_benchmark(self, symbol, start_date, end_date):
        """
        Yahoo Finance Ã¼zerinden Dolar (USDTRY=X) veya AltÄ±n (GC=F) verisi Ã§eker.
        """
        try:
            # BitiÅŸ tarihini 1 gÃ¼n ileri at (Yahoo Finance bazen son gÃ¼nÃ¼ keser)
            end_dt = pd.to_datetime(end_date) + pd.Timedelta(days=1)
            end_str = end_dt.strftime("%Y-%m-%d")

            # Veriyi indir
            df = yf.download(symbol, start=start_date, end=end_str, progress=False)
            
            if df.empty:
                return pd.DataFrame()

            # Veri setini temizle
            df = df.reset_index()
            
            # SÃ¼tun isimlerini dÃ¼zelt (Yahoo bazen MultiIndex dÃ¶ndÃ¼rÃ¼r)
            if isinstance(df.columns, pd.MultiIndex):
                # Sadece ilk seviyeyi (Price, Open vb.) al
                df.columns = df.columns.get_level_values(0)
            
            # Sadece Tarih ve KapanÄ±ÅŸ FiyatÄ± lazÄ±m
            # 'Close' veya 'Adj Close' sÃ¼tunu var mÄ± kontrol et
            col_name = "Adj Close" if "Adj Close" in df.columns else "Close"
            
            if col_name not in df.columns:
                 return pd.DataFrame() # Ä°stenen sÃ¼tun yoksa boÅŸ dÃ¶n

            df = df[["Date", col_name]].copy()
            df = df.rename(columns={col_name: "Price"})
            
            # Tarih formatÄ±nÄ± standartlaÅŸtÄ±r
            df["Date"] = pd.to_datetime(df["Date"])
            
            # Hafta sonlarÄ±nÄ± doldur (Fonlarla eÅŸleÅŸmesi iÃ§in)
            df = df.set_index("Date").resample("D").ffill().reset_index()

            return df

        except Exception as e:
            print(f"Piyasa verisi hatasÄ± ({symbol}): {e}")
            return pd.DataFrame()

==================================================
DOSYA ADI: .\core\processor.py
==================================================

import pandas as pd
import numpy as np
import scipy.optimize as sco
from datetime import datetime, timedelta
import warnings

# Gereksiz tarih formatÄ± uyarÄ±larÄ±nÄ± sustur
warnings.simplefilter(action='ignore', category=UserWarning)
warnings.simplefilter(action='ignore', category=FutureWarning)

class DataProcessor:
    def __init__(self):
        pass

    def clean_data(self, df):
        if df.empty: return df

        keep_cols = ['Date', 'Price', 'FundCode', 'FundName']
        existing_cols = [c for c in keep_cols if c in df.columns]
        df = df[existing_cols].copy()

        # 1. TARÄ°H DÃœZELTME
        if 'Date' in df.columns:
            try:
                # Ã–nce numeric mi diye bak (timestamp)
                if pd.api.types.is_numeric_dtype(df['Date']):
                    df['Date'] = pd.to_datetime(df['Date'], unit='ms')
                else:
                    df['Date'] = pd.to_datetime(df['Date'], errors='coerce', dayfirst=True)
            except:
                df['Date'] = pd.to_datetime(df['Date'], errors='coerce')

        # 2. FÄ°YAT DÃœZELTME
        if 'Price' in df.columns:
            if not pd.api.types.is_numeric_dtype(df['Price']):
                df['Price'] = df['Price'].astype(str).str.replace('.', '', regex=False)
                df['Price'] = df['Price'].str.replace(',', '.', regex=False)
                df['Price'] = pd.to_numeric(df['Price'], errors='coerce')

        df = df.dropna(subset=['Date', 'Price'])
        df = df.sort_values('Date').reset_index(drop=True)

        return df

    def add_financial_metrics(self, df):
        """Zaman serisi metrikleri (Grafik iÃ§in)"""
        if df.empty or 'Price' not in df.columns: return df
        
        df = df.copy()
        df = df.sort_values("Date")
        
        # GÃ¼nlÃ¼k Getiri
        df['Daily_Return'] = df['Price'].pct_change()
        
        # --- FIX: Sonsuz ve NaN deÄŸerleri temizle ---
        df['Daily_Return'] = df['Daily_Return'].replace([np.inf, -np.inf], np.nan)
        df['Daily_Return'] = df['Daily_Return'].fillna(0)

        # KÃ¼mÃ¼latif Getiri
        df['Cumulative_Return'] = (1 + df['Daily_Return']).cumprod() - 1
        df['MA_30'] = df['Price'].rolling(window=30).mean()
        
        return df

    def calculate_risk_metrics(self, df):
        """
        Ã–ZET Ä°STATÄ°STÄ°KLER (Tablo ve Scatter Grafik iÃ§in)
        """
        if df.empty or len(df) < 2:
            return None

        # Daily_Return yoksa hesapla ve temizle
        if 'Daily_Return' in df.columns:
            daily_returns = df['Daily_Return'].replace([np.inf, -np.inf], np.nan).fillna(0)
        else:
            daily_returns = df['Price'].pct_change().replace([np.inf, -np.inf], np.nan).fillna(0)
        
        # 1. Toplam Getiri (%)
        try:
            total_return = ((df['Price'].iloc[-1] - df['Price'].iloc[0]) / df['Price'].iloc[0])
        except:
            total_return = 0

        # 2. YÄ±llÄ±k Volatilite (Risk)
        volatility = daily_returns.std() * np.sqrt(252)

        # 3. Sharpe OranÄ±
        mean_return = daily_returns.mean() * 252
        if volatility == 0 or np.isnan(volatility):
            sharpe = 0
        else:
            sharpe = mean_return / volatility

        # 4. Maximum Drawdown
        rolling_max = df['Price'].cummax()
        drawdown = (df['Price'] - rolling_max) / rolling_max
        max_drawdown = drawdown.min()

        return {
            "Toplam Getiri": total_return,
            "YÄ±llÄ±k Volatilite (Risk)": volatility,
            "Sharpe OranÄ±": sharpe,
            "Max Drawdown (En BÃ¼yÃ¼k KayÄ±p)": max_drawdown
        }

    def calculate_period_returns(self, df):
        if df.empty: return {}

        df = df.sort_values("Date")
        latest_date = df.iloc[-1]["Date"]
        latest_price = df.iloc[-1]["Price"]
        
        periods = {"1 Ay": 30, "3 Ay": 90, "6 Ay": 180, "1 YÄ±l": 365}
        results = {}
        
        for name, days in periods.items():
            target_date = latest_date - timedelta(days=days)
            past_data = df[df["Date"] <= target_date]
            
            if not past_data.empty:
                past_price = past_data.iloc[-1]["Price"]
                if past_price > 0:
                    ret = (latest_price - past_price) / past_price
                    results[name] = ret
                else: results[name] = None
            else: results[name] = None

        current_year = latest_date.year
        ytd_data = df[df["Date"].dt.year < current_year]
        if not ytd_data.empty:
            ytd_price = ytd_data.iloc[-1]["Price"]
            results["YTD (YÄ±lbaÅŸÄ±)"] = (latest_price - ytd_price) / ytd_price
        else: results["YTD (YÄ±lbaÅŸÄ±)"] = None

        return results

    def calculate_correlation_matrix(self, full_df):
        if full_df.empty: return pd.DataFrame()
        pivot_df = full_df.pivot_table(index="Date", columns="FundCode", values="Price")
        returns_df = pivot_df.pct_change().dropna()
        return returns_df.corr()

    def normalize_for_comparison(self, df_fund, df_benchmark, benchmark_name="USD/TRY"):
        if df_fund.empty or df_benchmark.empty: return pd.DataFrame()

        merged = pd.merge(
            df_fund[["Date", "Price", "FundName"]],
            df_benchmark[["Date", "Price"]],
            on="Date", how="inner", suffixes=("", "_Bench")
        )
        if merged.empty: return pd.DataFrame()

        merged["Fund_Cumulative"] = (merged["Price"] / merged["Price"].iloc[0]) - 1
        merged[f"{benchmark_name}_Cumulative"] = (merged["Price_Bench"] / merged["Price_Bench"].iloc[0]) - 1
        return merged

    # ---------------------------------------------------------
    # SÄ°MÃœLASYON FONKSÄ°YONU
    # ---------------------------------------------------------
    def calculate_portfolio_simulation(self, full_df, weights_dict, initial_capital=100000):
        if full_df.empty or not weights_dict: return pd.DataFrame()

        selected_funds = list(weights_dict.keys())
        df_filtered = full_df[full_df['FundCode'].isin(selected_funds)].copy()
        
        # Pivot ve Temizlik (inf temizliÄŸi eklendi)
        pivot_returns = df_filtered.pivot_table(index='Date', columns='FundCode', values='Daily_Return')
        pivot_returns = pivot_returns.replace([np.inf, -np.inf], np.nan).dropna()

        if pivot_returns.empty: return pd.DataFrame()

        ordered_weights = []
        for code in pivot_returns.columns:
            ordered_weights.append(weights_dict.get(code, 0))
        
        total_weight = sum(ordered_weights)
        if total_weight > 0:
            ordered_weights = [w / total_weight for w in ordered_weights]
        else: return pd.DataFrame()

        portfolio_daily_ret = pivot_returns.dot(ordered_weights)
        
        portfolio_df = pd.DataFrame(index=portfolio_daily_ret.index)
        portfolio_df['Daily_Return'] = portfolio_daily_ret
        portfolio_df['Cumulative_Return'] = (1 + portfolio_df['Daily_Return']).cumprod() - 1
        portfolio_df['Price'] = initial_capital * (1 + portfolio_df['Cumulative_Return'])
        
        portfolio_df = portfolio_df.reset_index()
        portfolio_df['FundCode'] = "PORTFOY"
        portfolio_df['FundName'] = "SimÃ¼lasyon PortfÃ¶yÃ¼m"
        
        return portfolio_df

    # ---------------------------------------------------------
    # MARKOWITZ ETKÄ°N SINIR (DÃœZELTÄ°LMÄ°Å - HATA VERMEZ)
    # ---------------------------------------------------------
    def calculate_efficient_frontier(self, full_df, selected_funds, num_portfolios=2000):
        if full_df.empty or len(selected_funds) < 2:
            return pd.DataFrame(), {}

        # Veri HazÄ±rlama
        df_filtered = full_df[full_df['FundCode'].isin(selected_funds)].copy()
        
        try:
            pivot_returns = df_filtered.pivot_table(index='Date', columns='FundCode', values='Daily_Return')
        except:
            return pd.DataFrame(), {}

        # --- Temizlik: SonsuzlarÄ± ve NaN'larÄ± uÃ§ur ---
        pivot_returns = pivot_returns.replace([np.inf, -np.inf], np.nan).dropna()

        if pivot_returns.empty:
            return pd.DataFrame(), {}

        mean_returns = pivot_returns.mean() * 252
        cov_matrix = pivot_returns.cov() * 252
        num_assets = len(pivot_returns.columns)

        # --- FIX: VarsayÄ±lan deÄŸerler (Crash KorumasÄ±) ---
        # EÄŸer optimizasyon baÅŸarÄ±sÄ±z olursa boÅŸ liste dÃ¶nmesin diye EÅŸit AÄŸÄ±rlÄ±k atÄ±yoruz.
        optimal_weights = np.ones(num_assets) / num_assets 
        max_sharpe_ratio = -1e9 # Ã‡ok dÃ¼ÅŸÃ¼k baÅŸlatÄ±yoruz

        results = []

        # 1. SimÃ¼lasyon (Rastgele)
        for _ in range(num_portfolios):
            weights = np.random.random(num_assets)
            weights /= np.sum(weights)

            portfolio_return = np.sum(mean_returns * weights)
            portfolio_std_dev = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights)))
            
            if portfolio_std_dev == 0: sharpe_ratio = 0
            else: sharpe_ratio = portfolio_return / portfolio_std_dev

            results.append({
                'Return': portfolio_return,
                'Volatility': portfolio_std_dev,
                'Sharpe': sharpe_ratio
            })

        # 2. Scipy Optimizasyonu (Matematiksel)
        def neg_sharpe(weights):
            p_ret = np.sum(mean_returns * weights)
            p_vol = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights)))
            return -p_ret / p_vol if p_vol > 0 else 0

        constraints = ({'type': 'eq', 'fun': lambda x: np.sum(x) - 1})
        bounds = tuple((0, 1) for _ in range(num_assets))
        initial_guess = num_assets * [1. / num_assets,]

        try:
            opt_result = sco.minimize(neg_sharpe, initial_guess, method='SLSQP', bounds=bounds, constraints=constraints)
            if opt_result.success:
                optimal_weights = opt_result.x
                # Ä°yileÅŸtirilmiÅŸ Sharpe
                p_ret = np.sum(mean_returns * optimal_weights)
                p_vol = np.sqrt(np.dot(optimal_weights.T, np.dot(cov_matrix, optimal_weights)))
                max_sharpe_ratio = p_ret / p_vol if p_vol > 0 else 0
        except:
            pass # Hata olursa varsayÄ±lan (eÅŸit aÄŸÄ±rlÄ±k) kalÄ±r

        sim_df = pd.DataFrame(results)
        
        # SonuÃ§larÄ± paketle (optimal_weights artÄ±k asla boÅŸ deÄŸil)
        best_weights = {col: round(w, 2) for col, w in zip(pivot_returns.columns, optimal_weights)}
        
        best_portfolio_stats = {
            'Return': np.sum(mean_returns * optimal_weights),
            'Volatility': np.sqrt(np.dot(optimal_weights.T, np.dot(cov_matrix, optimal_weights))),
            'Sharpe': max_sharpe_ratio,
            'Weights': best_weights
        }
        
        return sim_df, best_portfolio_stats

    # ---------------------------------------------------------
    # VAR (VALUE AT RISK)
    # ---------------------------------------------------------
    def calculate_value_at_risk(self, full_df, weights_dict, initial_capital=100000, confidence_level=0.95):
        if full_df.empty or not weights_dict: return None

        sim_df = self.calculate_portfolio_simulation(full_df, weights_dict, initial_capital)
        if sim_df.empty: return None

        returns = sim_df['Daily_Return']
        mean = returns.mean()
        std = returns.std()

        if confidence_level == 0.95: z_score = 1.645
        elif confidence_level == 0.99: z_score = 2.33
        else: z_score = 1.645

        var_percent = (z_score * std) - mean
        var_amount = initial_capital * var_percent

        return {
            "VaR_Amount": abs(var_amount),
            "VaR_Percent": var_percent,
            "Confidence": confidence_level
        }

    # ---------------------------------------------------------
    # MONTE CARLO SÄ°MÃœLASYONU
    # ---------------------------------------------------------
    def run_monte_carlo_simulation(self, full_df, weights_dict, initial_capital, days_forward=180, num_simulations=50):
        if full_df.empty or not weights_dict: return pd.DataFrame()

        sim_df = self.calculate_portfolio_simulation(full_df, weights_dict, initial_capital)
        if sim_df.empty: return pd.DataFrame()

        returns = sim_df['Daily_Return']
        mu = returns.mean()
        sigma = returns.std()
        
        last_date = sim_df['Date'].max()
        future_dates = [last_date + timedelta(days=i) for i in range(1, days_forward + 1)]
        
        results = pd.DataFrame({'Date': future_dates})
        
        for i in range(num_simulations):
            shocks = np.random.normal(0, 1, days_forward)
            sim_returns = (mu - 0.5 * sigma**2) + (sigma * shocks)
            
            price_path = [initial_capital]
            for r in sim_returns:
                price_path.append(price_path[-1] * np.exp(r))
            
            results[f'Sim_{i}'] = price_path[1:]
            
        return results

    # ---------------------------------------------------------
    # REEL GETÄ°RÄ° (ENFLASYONLU)
    # ---------------------------------------------------------
    def calculate_real_returns(self, df, inflation_df):
        if df.empty or 'Cumulative_Return' not in df.columns: return df
        if inflation_df is None or inflation_df.empty: return df 
        
        df = df.copy()
        df['YearMonth'] = df['Date'].dt.to_period('M')
        
        inf_copy = inflation_df.copy()
        if 'Tarih' in inf_copy.columns:
            inf_copy['Date'] = pd.to_datetime(inf_copy['Tarih'])
        inf_copy['YearMonth'] = inf_copy['Date'].dt.to_period('M')
        
        # SÃ¼tun adÄ± kontrolÃ¼
        target_col = 'Oran' if 'Oran' in inf_copy.columns else 'AylÄ±k Enflasyon'
        if target_col not in inf_copy.columns: return df

        merged = pd.merge(df, inf_copy[['YearMonth', target_col]], on='YearMonth', how='left')
        
        # Eksikleri doldur
        last_val = inf_copy[target_col].iloc[-1] if not inf_copy.empty else 3.0
        merged[target_col] = merged[target_col].fillna(last_val)
        
        merged['Daily_Inf_Factor'] = (1 + (merged[target_col]/100))**(1/30)
        merged['Cum_Inf_Index'] = merged['Daily_Inf_Factor'].cumprod()
        merged['Real_Return'] = ((1 + merged['Cumulative_Return']) / merged['Cum_Inf_Index']) - 1
        
        return merged

==================================================
DOSYA ADI: .\core\tefas_fetcher.py
==================================================

import pandas as pd
import time
import random
from datetime import datetime, timedelta, date
import undetected_chromedriver as uc
import json
import sys

class TefasFetcher:
    def __init__(self):
        print("ğŸ”§ Chrome TarayÄ±cÄ±sÄ± HazÄ±rlanÄ±yor...")
        self.driver = None
        
        # --- GÃœVENLÄ° AÃ‡ILIÅ DÃ–NGÃœSÃœ ---
        for deneme in range(3):
            try:
                options = uc.ChromeOptions()
                options.add_argument("--no-sandbox")
                options.add_argument("--disable-dev-shm-usage")
                # options.add_argument("--headless") # GÃ¶rmek iÃ§in kapalÄ± tutuyoruz
                
                self.driver = uc.Chrome(options=options, use_subprocess=True)
                self.driver.set_page_load_timeout(60)
                
                # Siteye Git
                print(f"ğŸŒ TEFAS'a baÄŸlanÄ±lÄ±yor... (Deneme: {deneme+1})")
                self.driver.get("https://www.tefas.gov.tr/TarihselVeriler.aspx")
                
                time.sleep(3)
                print("âœ… BaÄŸlantÄ± BaÅŸarÄ±lÄ±.")
                break 
                
            except Exception as e:
                print(f"âš ï¸ Chrome aÃ§Ä±lÄ±rken hata oldu: {e}")
                if self.driver:
                    try: self.driver.quit()
                    except: pass
                time.sleep(2)
        
        if self.driver is None:
            print("âŒ KRÄ°TÄ°K HATA: Chrome aÃ§Ä±lamadÄ±!")

    def fetch_data(self, fund_code, start_date, end_date):
        """
        Fiyat verilerini 90 gÃ¼nlÃ¼k parÃ§alar halinde Ã§eker.
        """
        if not self.driver: 
            print("âŒ Driver yok, iÅŸlem iptal.")
            return pd.DataFrame()

        print(f"\nğŸ” {fund_code} iÃ§in veri isteniyor: {start_date} -> {end_date}")

        all_data_frames = []
        
        # --- TARÄ°H FORMATI GARANTÄ°LEME ---
        # Gelen veri datetime objesi mi, string mi? Hepsini datetime yapalÄ±m.
        try:
            if isinstance(start_date, (datetime, date)):
                current_date = pd.to_datetime(start_date)
            else:
                current_date = pd.to_datetime(start_date) # String ise Ã§evir
            
            if isinstance(end_date, (datetime, date)):
                target_end_date = pd.to_datetime(end_date)
            else:
                target_end_date = pd.to_datetime(end_date)

        except Exception as e:
            print(f"âŒ Tarih format hatasÄ±: {e}")
            return pd.DataFrame()

        # DÃ¶ngÃ¼ BaÅŸlangÄ±cÄ±
        while current_date <= target_end_date:
            chunk_end = current_date + timedelta(days=90)
            if chunk_end > target_end_date:
                chunk_end = target_end_date
            
            # TEFAS'Ä±n istediÄŸi format: GG.AA.YYYY (Ã–rn: 01.01.2023)
            s_str = current_date.strftime("%d.%m.%Y")
            e_str = chunk_end.strftime("%d.%m.%Y")
            
            print(f"   â³ ParÃ§a Ä°steÄŸi: {s_str} - {e_str} ...", end="")
            
            df_chunk = self._fetch_chunk_with_js(fund_code, s_str, e_str)
            
            if not df_chunk.empty:
                print(f" âœ… Geldi ({len(df_chunk)} satÄ±r)")
                all_data_frames.append(df_chunk)
            else:
                print(f" âš ï¸ BoÅŸ dÃ¶ndÃ¼")
            
            current_date = chunk_end + timedelta(days=1)
            time.sleep(random.uniform(0.5, 1.0))

        # BirleÅŸtirme
        if all_data_frames:
            full_df = pd.concat(all_data_frames, ignore_index=True)
            full_df = full_df.drop_duplicates(subset=['Date'])
            print(f"ğŸ‰ TOPLAM: {len(full_df)} satÄ±r veri Ã§ekildi.")
            return full_df
        
        print("âŒ HÄ°Ã‡ VERÄ° ALINAMADI (Liste boÅŸ)")
        return pd.DataFrame()

    def _fetch_chunk_with_js(self, fund_code, start_fmt, end_fmt):
        # JavaScript API Ã‡aÄŸrÄ±sÄ±
        js_script = f"""
        var callback = arguments[arguments.length - 1];
        var formData = "fontip=YAT&sfontur=&fonkod={fund_code.upper()}&fongrup=&bastarih={start_fmt}&bittarih={end_fmt}&fonturkod=&fonunvantip=";
        
        fetch("https://www.tefas.gov.tr/api/DB/BindHistoryInfo", {{
            method: "POST",
            headers: {{ 
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", 
                "X-Requested-With": "XMLHttpRequest" 
            }},
            body: formData
        }})
        .then(r => r.json())
        .then(d => callback(d))
        .catch(e => callback({{ "error": e.toString() }}));
        """
        try:
            result = self.driver.execute_async_script(js_script)
            
            if result and "data" in result:
                data_list = result["data"]
                # Bazen TEFAS boÅŸ liste dÃ¶ner
                if not data_list:
                    return pd.DataFrame()

                df = pd.DataFrame(data_list)
                if not df.empty:
                    # SÃ¼tunlarÄ± yeniden adlandÄ±r
                    df = df.rename(columns={"TARIH": "Date", "FIYAT": "Price", "FONKODU": "FundCode", "FONUNVAN": "FundName"})
                    
                    # Tarih formatÄ±nÄ± (Unix Timestamp) dÃ¼zelt (TEFAS 1672531200000 gibi dÃ¶ner)
                    if 'Date' in df.columns:
                        # SayÄ±sal veri mi kontrol et
                        df['Date'] = pd.to_numeric(df['Date'], errors='coerce')
                        df['Date'] = pd.to_datetime(df['Date'], unit='ms') # Milisaniye -> Tarih
                        
                    return df
            
            return pd.DataFrame()

        except Exception as e:
            print(f" [JS HatasÄ±]: {e}")
            return pd.DataFrame()

    # ----------------------------------------------------------------
    # FAIL-SAFE VARLIK DAÄILIMI (Ã‡Ã–KMEZ)
    # ----------------------------------------------------------------
    def fetch_asset_allocation(self, fund_code, target_date_str):
        if not self.driver: return pd.DataFrame()

        # print(f"ğŸ” {fund_code} VarlÄ±k DaÄŸÄ±lÄ±mÄ± aranÄ±yor...") # Ã‡ok log basmasÄ±n diye kapattÄ±m

        try:
            # Tarih string mi, datetime mÄ± kontrol et
            if isinstance(target_date_str, str):
                end_dt = datetime.strptime(target_date_str, "%Y-%m-%d")
            else:
                end_dt = pd.to_datetime(target_date_str) # Timestamp ise Ã§evir

            start_dt = end_dt - timedelta(days=365) 
            s_fmt = start_dt.strftime("%d.%m.%Y")
            e_fmt = end_dt.strftime("%d.%m.%Y")

        except Exception as e:
            # print(f"âŒ Tarih hatasÄ± (Asset): {e}")
            return pd.DataFrame()

        js_script = f"""
        var callback = arguments[arguments.length - 1];
        var formData = "fontip=YAT&sfontur=&fonkod={fund_code.upper()}&fongrup=&bastarih={s_fmt}&bittarih={e_fmt}&fonturkod=&fonunvantip=";
        
        fetch("https://www.tefas.gov.tr/api/DB/BindAllocationInfo", {{
            method: "POST",
            headers: {{ "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "X-Requested-With": "XMLHttpRequest" }},
            body: formData
        }})
        .then(r => r.text()) // Ã–nce text al (HTML gelirse patlamasÄ±n)
        .then(text => {{
            try {{
                var json = JSON.parse(text);
                callback(json);
            }} catch (e) {{
                callback({{ "error": "JSON Parse Error" }});
            }}
        }})
        .catch(e => callback({{ "error": e.toString() }}));
        """

        try:
            result = self.driver.execute_async_script(js_script)
            
            if result and "data" in result:
                full_data = pd.DataFrame(result["data"])
                if not full_data.empty and 'TARIH' in full_data.columns:
                    # Tarihi Parse Et
                    full_data['Parsed_Date'] = pd.to_numeric(full_data['TARIH'], errors='coerce')
                    full_data['Parsed_Date'] = pd.to_datetime(full_data['Parsed_Date'], unit='ms')
                    full_data = full_data.dropna(subset=['Parsed_Date'])
                    
                    if not full_data.empty:
                        latest_date = full_data['Parsed_Date'].max()
                        latest_df = full_data[full_data['Parsed_Date'] == latest_date].copy()
                        return latest_df[["ITEM", "DEGER"]].rename(columns={"ITEM": "VarlÄ±k TÃ¼rÃ¼", "DEGER": "Oran"})
            
            return pd.DataFrame()

        except: return pd.DataFrame()

    def close(self):
        try:
            if self.driver: self.driver.quit()
        except: pass

==================================================
DOSYA ADI: .\core\visualizer.py
==================================================

import plotly.express as px
import plotly.graph_objects as go
import pandas as pd
import os

class Visualizer:
    def __init__(self):
        pass

    def create_performance_chart(self, df):
        """
        TÃ¼m fonlarÄ±n kÃ¼mÃ¼latif getirilerini karÅŸÄ±laÅŸtÄ±rmalÄ± Ã§izgi grafik yapar.
        Ã‡Ä±ktÄ±yÄ± HTML dosyasÄ± olarak kaydeder.
        """
        if df.empty:
            print("  [GRAFÄ°K] Veri yok, grafik Ã§izilemedi.")
            return

        # Tarihe gÃ¶re sÄ±ralayalÄ±m ki Ã§izgiler dÃ¼zgÃ¼n olsun
        df = df.sort_values('Date')

        # Grafik BaÅŸlÄ±ÄŸÄ± ve AyarlarÄ±
        fig = px.line(
            df, 
            x="Date", 
            y="Cumulative_Return", 
            color="FundCode",
            title="Fon Performans KarÅŸÄ±laÅŸtÄ±rmasÄ± (KÃ¼mÃ¼latif Getiri)",
            labels={
                "Date": "Tarih",
                "Cumulative_Return": "Getiri OranÄ±",
                "FundCode": "Fon Kodu"
            },
            template="plotly_dark" # ÅÄ±k, koyu tema
        )

        # Y eksenini YÃ¼zde (%) formatÄ±na Ã§evirelim
        fig.layout.yaxis.tickformat = ',.0%'

        # Mouse ile Ã¼zerine gelince detaylÄ± bilgi Ã§Ä±ksÄ±n
        fig.update_traces(mode="lines", hovertemplate='%{y:.2%}')

        # KlasÃ¶r kontrolÃ¼
        if not os.path.exists('reports'):
            os.makedirs('reports')

        # Kaydet
        output_path = "reports/Performans_Grafigi.html"
        fig.write_html(output_path)
        
        print(f"ğŸ“ˆ GRAFÄ°K OLUÅTURULDU: {output_path}")
        print("   (Bu dosyayÄ± tarayÄ±cÄ±nÄ±zda aÃ§abilirsiniz.)")
